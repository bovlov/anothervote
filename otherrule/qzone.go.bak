package otherrule

// 基础包
import (
	"github.com/henrylee2cn/pholcus/app/downloader/request" //必需
	. "github.com/henrylee2cn/pholcus/app/spider"           //必需
	. "github.com/henrylee2cn/pholcus/app/spider/common"    //选用
	"github.com/henrylee2cn/pholcus/common/goquery"         //DOM解析
	"github.com/henrylee2cn/pholcus/logs"                   //信息输出

	// net包
	"net/http" //设置http.Header
	// "net/url"

	// 编码包
	// "encoding/xml"
	// "encoding/json"

	// 字符串处理包
	// "regexp"
	//"strconv"
	"strings"

	// 其他包
	"fmt"
	// "math"
	// "time"
	// "io/ioutil"
)

func init() {
	QzoneArticles.Register()
}

var QzoneArticles = &Spider{
	Name:         "QZONE",
	Description:  `QZONE [自定义输入格式 "ID"::"Cookie"][最多支持250页，内设定时1~2s]`,
	Pausetime:    2000,
	Keyin:        KEYIN,
	Limit:        LIMIT,
	EnableCookie: true,
	RuleTree: &RuleTree{
		Root: func(ctx *Context) {
			param := strings.Split(ctx.GetKeyin(), "::")
			if len(param) != 2 {
				logs.Log.Error("自定义输入的参数不正确！")
				return
			}
			id := strings.Trim(param[0], " ")
			cookie := strings.Trim(param[1], " ")

			var count1 = 250
			var count2 = 50

			if ctx.GetLimit() < count1 {
				count1 = ctx.GetLimit()
			}
			if ctx.GetLimit() < count2 {
				count2 = ctx.GetLimit()
			}
			for i := count1; i > 0; i-- {
				ctx.AddQueue(&request.Request{
					Url:  "https://rc.qzone.qq.com/blog",
					Rule: "文章列表",
					Header: http.Header{
						"Cookie":     []string{cookie},
						"Referer":    []string{"https://user.qzone.qq.com/" + id},
						"User-Agent": []string{"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36"},
					},
					DownloaderID: 0,
				})
			}
		},

		Trunk: map[string]*Rule{
			"文章列表": {
				ItemFields: []string{
					"文章名",
					"blogid",
					"url",
				},
				ParseFunc: func(ctx *Context) {
					query := ctx.GetDom()
					// 找到文章链接 加入队列
					logs.Log.Error("QZONE START RUNING---> %v", query.Find(".article").Text())
					结果 := map[int]interface{}{
						0: ctx.GetTemp("好友名", ""),
						1: ctx.GetTemp("好友ID", ""),
						2: ctx.GetTemp("认证", ""),
					}
					//var i int = 0
					query.Find(".article").Each(func(i int, s *goquery.Selection) {
						if i > 3 {
							return
						}

						//fmt.Println("222")
						artLink := s.Find(".c_tx2 a")
						title, _ := artLink.Attr("title")
						name := artLink.Find("span").Text()
						fmt.Println(name)
						url, _ := artLink.Attr("href")
						blogid, _ := artLink.Attr("blogid")

						logs.Log.Error("i=%d title=%s name=%v url=%v blogid=%v\n", i, title, name, url, blogid)
						结果[i] = title

						/*
							x := &request.Request{
								Url:          url,
								Rule:         "文章详情",
								DownloaderID: 0,
								Temp: map[string]interface{}{
									"好友名":  name,
									"好友ID": uid,
									"认证":   认证,
									"关注":   关注,
									"粉丝":   粉丝,
									"微博":   微博,
								},
							}
							ctx.AddQueue(x)
						*/
					})
					// 结果输出
					ctx.Output(结果)
				},
			},
			"文章详情": {
				ItemFields: []string{
					"好友名",
					"好友ID",
					"认证",
					"关注",
					"粉丝",
					"微博",
				},
				ParseFunc: func(ctx *Context) {
					query := ctx.GetDom()
					var 属性 map[string]string
					var title string
					var detail string
					query.Find(".li_1").Each(func(i int, s *goquery.Selection) {
						if 属性 == nil {
							属性 = map[string]string{}
						}
						title = s.Find(".pt_title").Text()
						title = Deprive2(title)
						detail = s.Find(".pt_detail").Text()
						detail = Deprive2(detail)
						属性[title] = detail
					})
					结果 := map[int]interface{}{
						0: ctx.GetTemp("好友名", ""),
						1: ctx.GetTemp("好友ID", ""),
						2: ctx.GetTemp("认证", ""),
						3: ctx.GetTemp("关注", ""),
						4: ctx.GetTemp("粉丝", ""),
						5: ctx.GetTemp("微博", ""),
					}
					for k, v := range 属性 {
						idx := ctx.UpsertItemField(k)
						结果[idx] = v
					}

					// 结果输出
					ctx.Output(结果)
				},
			},
		},
	},
}
